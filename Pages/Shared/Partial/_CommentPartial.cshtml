@model IEnumerable<PRN_MANGA_PROJECT.Models.Entities.Comment>

@* @section Styles {
	<link rel="stylesheet" href="~/css/Comment.css" />
} *@
@{
	var currentUserId = ViewData["CurrentUserId"] as string;
	var currentUser = ViewData["CurrentUser"] as string;
	var isAdmin = User.IsInRole("Admin");
}
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
<div id="comment-list-container" data-chapter-id="@ViewData["ChapterId"]" data-user-id="@ViewData["CurrentUserId"]">

@foreach (var comment in Model)
{
	<div class="container bootdey">
		<div class="col-md-12 bootstrap snippets">
			<div class="panel">
				<div class="panel-body">
					<!-- Newsfeed Content -->
					<!--===================================================-->
					<div class="media-block">
						<a class="media-left" href="#"><img class="img-circle img-sm" alt="Profile Picture" src="https://bootdey.com/img/Content/avatar/avatar1.png"></a>
						<div class="media-body">
							<div class="mar-btm">
								<a href="#" class="btn-link text-semibold media-heading box-inline">@comment.User.UserName</a>
									@{
										var timeSpan = DateTime.Now - comment.CreatedAt;
										string timeAgo;

										if (timeSpan.TotalMinutes < 1)
											timeAgo = "just now";
										else if (timeSpan.TotalMinutes < 60)
											timeAgo = $"{(int)timeSpan.TotalMinutes} minute{(timeSpan.TotalMinutes >= 2 ? "s" : "")} ago";
										else if (timeSpan.TotalHours < 24)
											timeAgo = $"{(int)timeSpan.TotalHours} hour{(timeSpan.TotalHours >= 2 ? "s" : "")} ago";
										else if (timeSpan.TotalDays < 7)
											timeAgo = $"{(int)timeSpan.TotalDays} day{(timeSpan.TotalDays >= 2 ? "s" : "")} ago";
										else if (timeSpan.TotalDays < 30)
											timeAgo = $"{(int)(timeSpan.TotalDays / 7)} week{(timeSpan.TotalDays / 7 >= 2 ? "s" : "")} ago";
										else if (timeSpan.TotalDays < 365)
											timeAgo = $"{(int)(timeSpan.TotalDays / 30)} month{(timeSpan.TotalDays / 30 >= 2 ? "s" : "")} ago";
										else
											timeAgo = $"{(int)(timeSpan.TotalDays / 365)} year{(timeSpan.TotalDays / 365 >= 2 ? "s" : "")} ago";
									}

									<p class="text-muted text-sm">@timeAgo</p>



									@{
										// Tạo biến để code dễ đọc hơn
										bool isAuthor = currentUserId != null && currentUserId == comment.UserId;
									}

									@if (isAuthor || isAdmin)
									{
										<div class="dropdown">
											<button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
												<i class="fa fa-ellipsis-v"></i>
											</button>
											<ul class="dropdown-menu dropdown-menu-end">

												@if (isAuthor)
												{
													<li>
														<a class="dropdown-item btn-edit" href="#" data-comment-id="@comment.Id">
															<i class="fa fa-pencil"></i> Edit
														</a>
													</li>
												}

												<li>
													<form method="post" asp-page="Chapter" asp-page-handler="DeleteComment" class="comment-action-form">
														<input type="hidden" name="Input.Id" value="@comment.Id" />
														<input type="hidden" name="Input.ChapterId" value="@comment.ChapterId" />
														<button type="submit" class="dropdown-item text-danger" onclick="return confirm('Do you want remove?') ;">
															<i class="fa fa-trash"></i> Delete
														</button>
													</form>
												</li>
											</ul>
										</div>
									}
							</div>

							<p class="comment-content">@comment.Content</p>
								<form method="post" asp-page="Chapter" asp-page-handler="EditComment" class="edit-form comment-action-form"
									  style="display: none;">
								<textarea name="Input.Content" class="form-control" rows="2">@comment.Content</textarea>
								<input type="hidden" name="Input.Id" value="@comment.Id" />
								<input type="hidden" name="Input.ChapterId" value="@comment.ChapterId" />
								<div class="mt-2">
									<button type="submit" class="btn btn-sm btn-primary">Save</button>
									<button type="button" class="btn btn-sm btn-secondary btn-cancel-edit">Cancel</button>
								</div>
							</form>
							<div class="pad-ver">
								<div class="btn-group">
										@{
											// Kiểm tra xem người dùng hiện tại đã "Like" (ReactionType = 1) comment này chưa
											bool isLikedByCurrentUser = comment.Likes.Any(l => l.UserId == currentUserId && l.ReactionType == 1);

											// (Tùy chọn) Kiểm tra luôn cho Dislike để đổi màu nút kia nếu cần
											bool isDislikedByCurrentUser = comment.Likes.Any(l => l.UserId == currentUserId && l.ReactionType == -1);
										}
										<form method="post" asp-page-handler="LikeComment" class="comment-action-form like-form">
											<input type="hidden" name="CommentId" value="@comment.Id" />
											<input type="hidden" name="ReactionType" value="1" />

											<button type="submit" class="btn btn-sm @(isLikedByCurrentUser ? "text-primary" : "")">
												<i class="fa fa-thumbs-up"></i> @comment.Likes.Count(l => l.ReactionType == 1)
											</button>
										</form>

										<form method="post" asp-page-handler="LikeComment" class="comment-action-form like-form">
											<input type="hidden" name="CommentId" value="@comment.Id" />
											<input type="hidden" name="ReactionType" value="-1" />

											<button type="submit" class="btn btn-sm @(isDislikedByCurrentUser ? "text-danger" : "")">
												<i class="fa fa-thumbs-down"></i> @comment.Likes.Count(l => l.ReactionType == -1)
											</button>
										</form>
								</div>
								<button type="button" class="btn btn-sm btn-default btn-hover-primary btn-reply"
										data-comment-id="@comment.Id">
									Reply
								</button>

							</div>
							
							<hr>
							<!-- Comments -->
								<form method="post" asp-page="Chapter"
									  asp-page-handler="Reply" class="comment-action-form">
								<div class="reply-container" style="display:none; margin-top:10px;">
									<div class="media-block">
										<div class="media-body">
											<div class="panel">
												<div class="panel-body">
													<textarea class="form-control" rows="2" placeholder="What are you thinking?" name="Input.Content"></textarea>
													<div class="mar-top clearfix">
														<button class="btn btn-sm btn-primary pull-right" type="submit"><i class="fa fa-pencil fa-fw"></i> Reply</button>
													</div>
												</div>
											</div>
											<hr>
											<input type="hidden" name="Input.ParentCommentId" class="parent-id" />
											<input type="hidden" name="Input.ChapterId" value="@comment.ChapterId" />

										</div>
									</div>
								</div>
							</form>
								@if (comment.Replies != null && comment.Replies.Any())
								{
									<button type="button"
											class="btn btn-link btn-sm btn-show-replies"
											data-comment-id="@comment.Id">
										Show more (@comment.Replies.Count())
									</button>

									<div id="reply-list-@comment.Id" class="reply-list" style="display:none;">
										<partial name="~/Pages/Shared/Partial/_ReplyPartial.cshtml" model="@comment.Replies" />
									</div>
								}

						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
}
</div>

