@model IEnumerable<PRN_MANGA_PROJECT.Models.Entities.Comment>

@section Styles {
	<link rel="stylesheet" href="~/css/Comment.css" />
}
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
@foreach (var comment in Model)
{
	<div class="container bootdey">
		<div class="col-md-12 bootstrap snippets">
			<div class="panel">
				<div class="panel-body">
					<!-- Newsfeed Content -->
					<!--===================================================-->
					<div class="media-block">
						<a class="media-left" href="#"><img class="img-circle img-sm" alt="Profile Picture" src="https://bootdey.com/img/Content/avatar/avatar1.png"></a>
						<div class="media-body">
							<div class="mar-btm">
								<a href="#" class="btn-link text-semibold media-heading box-inline">Lisa D.</a>
								<p class="text-muted text-sm"> 11 min ago</p>
							</div>

							<p class="comment-content">@comment.Content</p>
							<form method="post" asp-page="Chapter" asp-page-handler="EditComment" class="edit-form" style="display: none;">
								<textarea name="Input.Content" class="form-control" rows="2">@comment.Content</textarea>
								<input type="hidden" name="Input.Id" value="@comment.Id" />
								<input type="hidden" name="Input.ChapterId" value="@comment.ChapterId" />
								<div class="mt-2">
									<button type="submit" class="btn btn-sm btn-primary">Save</button>
									<button type="button" class="btn btn-sm btn-secondary btn-cancel-edit">Cancel</button>
								</div>
							</form>
							<div class="pad-ver">
								<div class="btn-group">
									<a class="btn btn-sm btn-default btn-hover-success" href="#"><i class="fa fa-thumbs-up"></i></a>
									<a class="btn btn-sm btn-default btn-hover-danger" href="#"><i class="fa fa-thumbs-down"></i></a>
								</div>
								<button type="button" class="btn btn-sm btn-default btn-hover-primary btn-reply"
										data-comment-id="@comment.Id">
									Reply
								</button>

							</div>
							<div class="dropdown">
								<button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
									<i class="fa fa-ellipsis-v"></i>
								</button>
								<ul class="dropdown-menu dropdown-menu-end">
									<li>
										<a class="dropdown-item btn-edit" href="#" data-comment-id="@comment.Id">
											<i class="fa fa-pencil"></i> Edit
										</a>
									</li>
									<li>
										<form method="post" asp-page="Chapter" asp-page-handler="DeleteComment">
											<input type="hidden" name="Input.Id" value="@comment.Id" />
											<input type="hidden" name="Input.ChapterId" value="@comment.ChapterId" />
											<button type="submit" class="dropdown-item text-danger" onclick="return confirm('Do you want remove?') ;">
												<i class="fa fa-trash"></i> Delete
											</button>
										</form>
									</li>
								</ul>
							</div>
							<hr>
							<!-- Comments -->
							<form method="post" asp-page="/Public/Manga/Chapter"
								  asp-page-handler="Reply">
								<div class="reply-container" style="display:none; margin-top:10px;">
									<div class="media-block">
										<a class="media-left" href="#"><img class="img-circle img-sm" alt="Profile Picture" src="https://bootdey.com/img/Content/avatar/avatar2.png"></a>
										<div class="media-body">
											<div class="mar-btm">
												<a href="#" class="btn-link text-semibold media-heading box-inline">Bobby Marz</a>
											</div>
											<div class="panel">
												<div class="panel-body">
													<textarea class="form-control" rows="2" placeholder="What are you thinking?" name="Input.Content"></textarea>
													<div class="mar-top clearfix">
														<button class="btn btn-sm btn-primary pull-right" type="submit"><i class="fa fa-pencil fa-fw"></i> Share</button>
														<a class="btn btn-trans btn-icon fa fa-video-camera add-tooltip" href="#"></a>
														<a class="btn btn-trans btn-icon fa fa-camera add-tooltip" href="#"></a>
														<a class="btn btn-trans btn-icon fa fa-file add-tooltip" href="#"></a>
													</div>
												</div>
											</div>
											<hr>
											<input type="hidden" name="Input.ParentCommentId" class="parent-id" />
											<input type="hidden" name="Input.ChapterId" value="@comment.ChapterId" />

										</div>
									</div>
								</div>
							</form>

							@foreach (var reply in comment.Replies)
							{
								<div>
									<div class="media-block">
										<a class="media-left" href="#"><img class="img-circle img-sm" alt="Profile Picture" src="https://bootdey.com/img/Content/avatar/avatar2.png"></a>
										<div class="media-body">
											<div class="mar-btm">
												<a href="#" class="btn-link text-semibold media-heading box-inline">Bobby Marz</a>
												<p class="text-muted text-sm"><i class="fa fa-mobile fa-lg"></i> 7 min ago</p>
											</div>
											<p>@reply.Content</p>
											<div class="pad-ver">
												<div class="btn-group">
													<a class="btn btn-sm btn-default btn-hover-success active" href="#"><i class="fa fa-thumbs-up"></i> You Like it</a>
													<a class="btn btn-sm btn-default btn-hover-danger" href="#"><i class="fa fa-thumbs-down"></i></a>
												</div>
												<a class="btn btn-sm btn-default btn-hover-primary" href="#">Reply</a>
											</div>
											<hr>
										</div>
									</div>
								</div>
							}
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

}
<script>

		const commentButtons = document.querySelectorAll(".btn-reply");

		commentButtons.forEach(button => {
			button.addEventListener("click", function () {
				const parentCommentId = this.dataset.commentId;
				const replyContainer = this.closest(".media-body").querySelector(".reply-container");
				if (!replyContainer) {
					console.warn("Không tìm thấy reply-container cho comment ID:", parentCommentId);
					return;
				}

				const hiddenInput = replyContainer.querySelector(".parent-id");
				if (hiddenInput) {
					hiddenInput.value = parentCommentId;
				} else {
					console.warn("Không tìm thấy input.parent-id trong reply-container của comment ID:", parentCommentId);
				}

				replyContainer.style.display =
					(replyContainer.style.display == "none" || replyContainer.style.display == "")
						? "block"
						: "none";
			});
		});

		const editButtons = document.querySelectorAll(".btn-edit");

	editButtons.forEach(btn => {
		btn.addEventListener("click", function (e) {
			e.preventDefault();

			const commentBlock = btn.closest(".media-body");
			const content = commentBlock.querySelector(".comment-content");
			const editForm = commentBlock.querySelector(".edit-form");

			content.style.display = "none";
			editForm.style.display = "block";

			// Gắn sự kiện Cancel
			const cancelBtn = editForm.querySelector(".btn-cancel-edit");
			cancelBtn.addEventListener("click", () => {
				editForm.style.display = "none";
				content.style.display = "block";
			});
		});
	});
</script>
